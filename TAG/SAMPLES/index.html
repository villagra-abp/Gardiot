<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>WebGL</title>
    <link rel="stylesheet" type="text/css" href="estilo.css">
    <script type="x-shader/v-shader" id="shader-vs">
        //declaramos vColor en vertex y fragment shader xq porque el valor de salida del vertex shader es el de entrada del fragment shader
        attribute vec3 aVertexPosition;
        attribute vec3 aVertexColor;
        attribute vec2 aVertexTexCoord;
        attribute vec3 aVertexNormal;

        uniform mat3 uNormalMatrix;
        uniform mat4 uMVMatrix;
        uniform mat4 uPMatrix;

        varying highp vec4 vColor;  
        varying highp vec3 vLight;
        varying highp vec2 vTextureCoord;

        void main(void) {
            gl_Position = uPMatrix * uMVMatrix * vec4(aVertexPosition, 1.0);
            vTextureCoord=aVertexTexCoord;
            vColor=vec4(1.0, 0.1, 0.1, 1.0);

            //lighting
            vec3 ambientLight = vec3(0.1, 0.1, 0.1);       

            vec3 pointLightPosition = vec3(1.0, 2.0, -1.0);
            vec3 pointLightDirection = normalize(vec3(pointLightPosition.xyz - aVertexPosition.xyz));

            vec3 L = vec3(uPMatrix * uMVMatrix * vec4(pointLightDirection, 1.0));
            vec3 N = uNormalMatrix * aVertexNormal;                    
            float diffuseLightAmount = max( dot(normalize(N), normalize(L)), 0.0);      
            
            vLight=ambientLight + vec3(.8, .8, .8) * diffuseLightAmount;
        }
    </script>
    <script type="x-shader/f-shader" id="shader-fs">
        varying highp vec4 vColor;
        varying highp vec3 vLight;
        varying highp vec2 vTextureCoord;

        uniform sampler2D uSampler;
        uniform sampler2D uSampler2;
        uniform int uDoTexturing;
        uniform int uDoLighting;

        void main(void) {
            if(uDoTexturing==1){
                highp vec4 stoneColor=texture2D(uSampler, vec2(vTextureCoord.st));
                highp vec4 gardiotLogo=texture2D(uSampler2, vec2(vTextureCoord.st));
                highp vec4 textureColor=mix(stoneColor, gardiotLogo, gardiotLogo.a);
                if(uDoLighting==1){
                    gl_FragColor=vec4(textureColor.xyz * vLight, textureColor.a);
                }else{
                    gl_FragColor=vec4(textureColor);
                }
                
            }else{
                if(uDoLighting==1){
                    gl_FragColor = vec4(vColor.xyz*vLight, vColor.a);
                }else{
                    gl_FragColor = vec4(vColor);
                }
                
            }
        }
    </script>

    <script src="codigo.js"></script>
    <script src="gl-matrix.js"></script>
    <script type="text/javascript" src="http://code.jquery.com/jquery-1.9.1.js"></script>
</head>
<body>

        <h1>Test WebGL</h1>
        <h3>Controles:</h3>
            <p>-P: Pausar o reanudar movimiento</p>
            <p>-T: Activar o desactivar texturas</p>
            <p>-L: Activar o desactivar iluminaci贸n</p>
            <p>-Q: Elegir matriz perspectiva u ortogonal</p>
            <p>-Flechas de direcci贸n: Mover el objeto</p>
            <p>-WASD: Cambiar rotaci贸n del objeto</p>

        <canvas id="my-canvas" width="600" height="450">
            Tu navegador no soporta el elemento canvas de HTML5.

        </canvas>


    <script>
    //variables de control
        var paused=false,
            useTexture=true,
            useLighting=true,
            matriz=false;


        var gl=null,
            canvas=null,
            glProgram=null,
            fragmentShader=null,
            vertexShader=null,
            angle=0;

        var vertexPositionAttribute=null,
            trianglesVerticeBuffer=null,
            //variables para almacer el atributo color y el bufer de los datos de color
            vertexColorAttribute=null,
            trianglesColorBuffer=null,

            //declaramos las matrices model-view y projection
            mvMatrix=mat4.create(),
            pMatrix=mat4.create(),

            //variables de texturas
            vertexTexCoordAttribute=null,
            trianglesTexCoordBuffer=null,
            STONE_TEXTURE=0,
            GARDIOT_LOGO=1,
            texture=[],
            textureImage=[],

            //variables de iluminaci贸n
            vertexNormalAttribute=null,
            trianglesNormalBuffer=null,
            normalMatrix=mat3.create();

            x=0,
            y=-1,
            sentido=[0.0, 1.0, 0.0];

        initWebGL();

        $(document).keydown(function(evt){
            switch(evt.keyCode){
                case 80: //p
                    paused=!paused;
                    break;
                case 81: //q
                    matriz=!matriz;
                    break;
                case 84: //t
                    useTexture=!useTexture;
                    if(useTexture){
                        gl.uniform1i(glProgram.uDoTexturing, 1);
                    }else{
                        gl.uniform1i(glProgram.uDoTexturing, 0);
                    }
                    break;
                case 76: //l
                    useLighting=!useLighting;
                    if(useLighting){
                        gl.uniform1i(glProgram.uDoLighting, 1);
                    }else{
                        gl.uniform1i(glProgram.uDoLighting, 0);
                    }
                    break;
                case 40: //down
                    y=y-0.2;
                    break;
                case 38: //up
                    y=y+0.2;
                    break;
                case 37: //left
                    x=x-0.2;
                    break;
                case 39: //right
                    x=x+0.2;
                    break;
                case 87:
                    sentido=[-1.0, 0.0, 0.0];
                    break;
                case 83:
                    sentido=[1.0, 0.0, 0.0];
                    break;
                case 65:
                    sentido=[0.0, -1.0, 0.0];
                    break;
                case 68:
                    sentido=[0.0, 1.0, 0.0];
                    break;
                default:

                    break;
            }
        });

    </script>
</body>
</html>